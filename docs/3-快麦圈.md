# 快麦圈爬虫说明

## 1. 登录

### 1.1 登录页面

* url: http://m.kmq999.com/login
* method: GET
* rsp html
    * 需要从 `head`里，取出`name="csrf-token"`的`meta`tag，然后取出content值

        ```html
        <head>
            <meta name="csrf-token" content="0ChMMAAK4UZDKN0lRQxAe1pwimF9gTCtlSzMXntI">
        </head>
        ```

### 1.2 登录

* url: http://m.kmq999.com/login
* method: POST
* body: form
    * _token为页面中取出的content值
    * captcha可以为空

      | key      | value                                    |
                  |----------|------------------------------------------|
      | _token   | 0ChMMAAK4UZDKN0lRQxAe1pwimF9gTCtlSzMXntI |
      | phone    | 13587021931                              |
      | password | hxy197984                                |
      | captcha  |                                          |
* rsp: html
  * 判断 body.a的href属性值是否为http://m.kmq999.com/app/center/index，如果是则登录成功
    ```html
    <!DOCTYPE html>
    <html>
        <head>
            <meta charset="UTF-8" />
            <meta http-equiv="refresh" content="0;url='http://m.kmq999.com/app/center/index'" />

            <title>Redirecting to http://m.kmq999.com/app/center/index</title>
        </head>
        <body>
            Redirecting to <a href="http://m.kmq999.com/app/center/index">http://m.kmq999.com/app/center/index</a>.
        </body>
    </html>
    ```


## 2. 买号/抢单

### 2.1 买号token

* url: http://m.kmq999.com/app/buyer/index
* method: GET
* rsp html
    * 需要从 `head`里，取出`name="csrf-token"`的`meta`tag，然后取出content值

        ```html
        <head>
            <meta name="csrf-token" content="wUVqdztP8gSryZBxD3kkJ3jsw6PSdzcrVr2UXFfc">
        </head>
        ```

### 2.2 买号
* url: http://m.kmq999.com/app/buyer/tasks/step1
* method: GET
* rsp html
    * 查找`class="section"`的div(`div1`)
    * 遍历`div1`中每个class含有row的div(`div2`)
    * `div2`中找到`class="h6"`的div，取出买号名称
    * `div2`中找到`Button`tag，从`data-url`中得到抢单url
      ```html
      <div class="section">
          <div class="row no-gutters py-4 border-bottom ml-3">
              <div class="col-8">
                  <div class="h6">黄山清哈哈哈</div>
                  <div class="text-muted">淘宝网</div>
              </div>
              <div class="col-4">
                  <button data-url="http://m.kmq999.com/app/buyer/tasks/dispatcher/1858" class="btn btn-primary dispatcher"
                          disabled="disabled">派单中...
                  </button>
              </div>
          </div>
      </div>
      ```

### 2.3 抢单
* url: http://m.kmq999.com/app/buyer/tasks/dispatcher/1858 ，url为第2步中中得到的url
* method: POST
* header: 需要加上`X-CSRF-TOKEN:wUVqdztP8gSryZBxD3kkJ3jsw6PSdzcrVr2UXFfc`，token值在2.1中获得
* rsp: 返回`\u6d3e\u5355\u4e2d...`，需要进行unicode decode，得到`派单中...`。如果字符串不匹配则抢单出错。

### 2.4 查单
* url: http://m.kmq999.com/app/buyer/tasks/has_order
* method: POST
* header: 需要加上`X-CSRF-TOKEN:wUVqdztP8gSryZBxD3kkJ3jsw6PSdzcrVr2UXFfc`，token值在2.1中获得
* rsp: 返回0。返回值可能是可以接单数

## 3. 站点余额
* url: http://m.kmq999.com/app/center/cash
* method: GET
* rsp html
  * 查找`class='text-red'`的`span`,取出余额
    ```html
    <!DOCTYPE html>
    <html lang="zh-CN">
    <body class="center-cash-index-page buyer">
    <div id="app">
        <div class="p-0 py-3 container">
            <div class="row no-gutters">
                <div class="col-md-10 col-12 mt-3 mt-md-0">
                    <div class="wrapper">
                        <form method="post" action="" class="" autocomplete="off" id="form">
                            <div class="header-line border-bottom">
                                <h4>兑换金币</h4>
                            </div>
                            <div class="p-4 border-bottom">
                                <p class="m-0">账户金币： <span class="text-red">145.86</span> 金币
                                </p>
                                <p class="m-0">1 金币起兑换，1 金币等于 1 元。</p>
                            </div>
                            <div class="p-md-4 p-3">
                                <div class="form-group">
                                    <label class="label" for="coin">要兑换金币：</label>
                                    <input type="text" class="form-control" id="coin" name="coin"
                                           placeholder="填写要兑换的金币数量">
                                </div>
                                <div class="form-group">
                                    <label class="label" for="sum">可获得现金（元）：</label>
                                    <input type="text" name="sum" id="sum" class="form-control" value="">
                                </div>
                            </div>
                            <div class="border-top p-4 d-flex justify-content-center align-items-center">
                                <button type="submit" class="btn btn-primary" id="btn-submit">提现金币</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </body>
    </html>
    ```
    
## 4. 自动提现
* url: http://m.kmq999.com/app/center/cash
* method: POST
* body form
  * coin 必需是整数
  * sum 两位小数

    | key  | value |
    |------|-------|
    | coin | 1     |
    | sum  | 1.00  |
* rsp
  * message 不等于"\u91d1\u5e01\u5151\u6362\u6210\u529f\uff0c\u8bf7\u67e5\u770b\u4f59\u989d"为提现失败
  * "金币兑换成功，请查看余额"

```json
{
	"message": "\u91d1\u5e01\u5151\u6362\u6210\u529f\uff0c\u8bf7\u67e5\u770b\u4f59\u989d",
	"data": "",
	"url": "http:\/\/m.kmq999.com\/app\/center\/cash"
}
```
